name: Symfony API CI


on:
    schedule:
        - cron: '0 2 * * *'
    # Pour que SonarCloud fonctionne sur les Pull Requests, il est conseill√© de d√©commenter ceci :
    push:
         branches: [ "main" ]
    # pull_request:
    #   branches: [ "main" ]

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            actions: write
            contents: read
        strategy:
            matrix:
                php-version: ['8.5'] # Note: 8.5 n'est pas encore stable, v√©rifiez si 8.3 ou 8.4 suffit

        steps:
            # 1Ô∏è‚É£ Checkout code
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
              with:
                  fetch-depth: 0  # <--- MODIFICATION : Important pour l'analyse Sonar (Blame/New Code)

            # 2Ô∏è‚É£ Delete old artifacts
            - name: Delete old workflow runs
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  run_ids=$(gh run list --workflow "Symfony API CI" --json databaseId --jq '.[1:].[] | .databaseId')
                  if [ -z "$run_ids" ]; then
                    echo "Aucun ancien run √† supprimer."
                  else
                    for id in $run_ids; do
                      echo "Suppression du run ID: $id"
                      gh run delete "$id"
                    done
                  fi

            # 3Ô∏è‚É£ Installer PHP
            - name: Setup PHP
              uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1
              with:
                  php-version: ${{ matrix.php-version }}
                  extensions: mbstring, intl, pdo_mysql, xml, curl
                  coverage: pcov

            # 4Ô∏è‚É£ Snyk (SCA & SAST)
            - name: Snyk Open Source Check
              uses: snyk/actions/php@9adf32b1121593767fc3c057af55b55db032dc04
              continue-on-error: true
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

            - name: Snyk Code Check
              uses: snyk/actions/setup@9adf32b1121593767fc3c057af55b55db032dc04
            - run: snyk code test
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

            # 5Ô∏è‚É£ Installer Composer
            - name: Install Composer dependencies
              run: composer install --prefer-dist --no-progress --no-interaction

            # 6Ô∏è‚É£ Valider le composer.json
            - name: Composer validate
              run: composer validate --no-check-publish

            # 7Ô∏è‚É£ V√©rifier le style de code
            - name: PHP-CS-Fixer dry-run
              run: ./vendor/bin/php-cs-fixer fix --dry-run --diff

            # 8Ô∏è‚É£ Analyse statique avec PHPStan
            - name: PHPStan analysis
              run: ./vendor/bin/phpstan analyse -l 8 src

            # 9Ô∏è‚É£ Lancer les tests unitaires avec PHPUnit
            - name: Run PHPUnit
                # On g√©n√®re coverage.xml pour que SonarCloud le lise
              run: ./vendor/bin/phpunit --configuration phpunit.dist.xml --coverage-clover=coverage.xml --log-junit=test-report.xml

            # üîü SonarCloud Scan
            # On utilise l'action recommand√©e, mais SANS arguments car le fichier properties est lu.
            # Elle est plac√©e ICI pour pouvoir lire le coverage.xml g√©n√©r√© juste au-dessus.
            -   name: SonarQube Scan
                uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
                env:
                    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # 1Ô∏è‚É£1Ô∏è‚É£ Rector dry-run
            - name: Rector dry-run
              run: ./vendor/bin/rector process src --dry-run
